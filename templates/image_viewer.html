{% extends "base.html" %}

{% block title %}Visor de Imágenes - Visor de Imágenes SMB{% endblock %}

{% block content %}
<h2>Visor de Imágenes PNG desde SMB</h2>

<div class="smb-status" style="margin-bottom: 20px; padding: 15px; border-radius: 8px; {% if smb_status.connected %}background: #d4edda; border: 1px solid #c3e6cb;{% else %}background: #f8d7da; border: 1px solid #f5c6cb;{% endif %}">
    <strong>Estado de Conexión SMB:</strong>
    {% if smb_status.connected %}
        <span style="color: #155724;">✓ Conectado - {{ smb_status.images_found }} imágenes encontradas</span>
    {% else %}
        <span style="color: #721c24;">✗ Desconectado - {{ smb_status.error }}</span>
    {% endif %}
    <div style="margin-top: 5px; font-size: 0.9em; color: #666;">
        Última verificación: {{ smb_status.last_check }}
    </div>
    <button onclick="refreshImages(event)" class="btn btn-sm btn-primary" style="margin-top: 10px;">Actualizar Lista</button>
</div>

<div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: calc(100vh - 300px);">
    <!-- Left panel: Image list -->
    <div style="overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f8f9fa;">
        <h3 class="image-list-header" style="margin-top: 0;">Imágenes Disponibles ({{ images|length }})</h3>
        
        <input type="text" 
               id="search-box" 
               placeholder="Buscar por nombre..." 
               onkeyup="filterImages()"
               style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
        
        {% if images %}
            <div id="image-list" style="display: flex; flex-direction: column; gap: 5px;">
                {% for image in images %}
                <div class="image-item" 
                     data-filename="{{ image.filename }}"
                     data-machine="{{ image.machine_id }}"
                     data-core="{{ image.core_id }}"
                     onclick="showImage(event, '{{ image.full_path }}', '{{ image.filename }}', '{{ image.machine_id }}', '{{ image.core_id }}')"
                     style="padding: 10px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; background: white; transition: all 0.2s;">
                    <div style="font-weight: bold; color: #007bff; margin-bottom: 5px;">{{ image.filename }}</div>
                    <div style="font-size: 0.85em; color: #666;">
                        <div>Machine: {{ image.machine_id }}</div>
                        <div>Core: {{ image.core_id }}</div>
                        <div>Size: {{ (image.file_size / 1024) | round(2) }} KB</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="text-align: center; color: #666; margin-top: 20px;">
                No se encontraron imágenes PNG en el servidor SMB.
            </p>
        {% endif %}
    </div>
    
    <!-- Right panel: Image viewer -->
    <div style="overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: white;">
        <div id="image-viewer-content">
            <div style="text-align: center; color: #999; padding: 60px 20px;">
                <h3>Seleccione una imagen de la lista</h3>
                <p>Haga clic en cualquier nombre de imagen de la izquierda para visualizarla aquí.</p>
            </div>
        </div>
    </div>
</div>

<style>
.image-item:hover {
    background: #e3f2fd !important;
    border-color: #007bff !important;
    transform: translateX(5px);
}

.image-item.selected {
    background: #cfe2ff !important;
    border-color: #0d6efd !important;
    font-weight: bold;
}

#image-viewer-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.image-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.image-info h3 {
    margin-top: 0;
    color: #007bff;
}

.image-info .info-row {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 10px;
    margin: 5px 0;
}

.image-info .info-label {
    font-weight: bold;
    color: #666;
}
</style>

<script>
function showImage(event, fullPath, filename, machineId, coreId) {
    // Remove previous selection
    document.querySelectorAll('.image-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // Mark current selection
    event.currentTarget.classList.add('selected');
    
    // Encode the path properly for URL
    const encodedPath = encodeURIComponent(fullPath);
    
    // Display image
    const viewerContent = document.getElementById('image-viewer-content');
    viewerContent.innerHTML = `
        <div class="image-info">
            <h3>${filename}</h3>
            <div class="info-row">
                <span class="info-label">Machine:</span>
                <span>${machineId}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Core:</span>
                <span>${coreId}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Path:</span>
                <span style="font-family: monospace; font-size: 0.9em;">${fullPath}</span>
            </div>
        </div>
        <div style="text-align: center;">
            <div id="loading-indicator" style="padding: 40px; color: #666;">
                <div style="font-size: 48px;">⏳</div>
                <div>Cargando imagen...</div>
            </div>
            <img id="preview-image" src="{{ url_for('get_image', image_path='') }}${fullPath}" 
                 alt="${filename}"
                 style="display: none;"
                 onload="document.getElementById('loading-indicator').style.display='none'; this.style.display='block';"
                 onerror="this.style.display='none'; document.getElementById('loading-indicator').innerHTML='<div style=\\'color: red; padding: 20px;\\'><strong>Error:</strong> No se pudo cargar la imagen. Verifique la conexión SMB.</div>';">
        </div>
    `;
}

function filterImages() {
    const searchTerm = document.getElementById('search-box').value.toLowerCase();
    const imageItems = document.querySelectorAll('.image-item');
    let visibleCount = 0;
    
    imageItems.forEach(item => {
        const filename = item.getAttribute('data-filename').toLowerCase();
        const machine = item.getAttribute('data-machine').toLowerCase();
        const core = item.getAttribute('data-core').toLowerCase();
        
        if (filename.includes(searchTerm) || machine.includes(searchTerm) || core.includes(searchTerm)) {
            item.style.display = '';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Update the header with visible count
    const header = document.querySelector('.image-list-header');
    if (header) {
        header.textContent = `Imágenes Disponibles (${visibleCount} de {{ images|length }})`;
    }
}

function refreshImages(event) {
    const button = event.target;
    button.disabled = true;
    button.textContent = 'Actualizando...';
    
    fetch('{{ url_for("refresh_images") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Lista actualizada. Se encontraron ${data.images_found} imágenes.`);
            location.reload();
        } else {
            alert('Error al actualizar: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error de conexión: ' + error);
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = 'Actualizar Lista';
    });
}
</script>

{% endblock %}
